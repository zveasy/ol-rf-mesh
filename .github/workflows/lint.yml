name: Lint and Format

on:
  push:
    paths:
      - "backend/**"
      - "dashboard/**"
      - "firmware/**"
      - ".github/workflows/lint.yml"
  pull_request:
    paths:
      - "backend/**"
      - "dashboard/**"
      - "firmware/**"
      - ".github/workflows/lint.yml"

jobs:
  backend-lint:
    runs-on: ubuntu-latest
    container:
      image: python:3.11-slim
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install ruff==0.7.0 black==24.10.0 mypy==1.13.0
      - name: Ruff
        run: ruff check .
      - name: Black (check)
        run: black --check .
      - name: Mypy (basic)
        run: mypy --ignore-missing-imports app

  dashboard-lint:
    runs-on: ubuntu-latest
    container:
      image: node:20
    defaults:
      run:
        working-directory: dashboard
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: |
          npm ci
          npm install --no-save eslint@9.11.1 prettier@3.3.3 @typescript-eslint/parser@7.18.0 @typescript-eslint/eslint-plugin@7.18.0 eslint-plugin-react@7.37.0 eslint-plugin-react-hooks@5.0.0 eslint-plugin-jsx-a11y@6.10.0 eslint-config-prettier@9.1.0
      - name: ESLint
        run: npx eslint src --ext .ts,.tsx --max-warnings=0
      - name: Prettier (check)
        run: npx prettier --check "src/**/*.{ts,tsx,js,css}"

  firmware-lint:
    runs-on: ubuntu-latest
    container:
      image: silkeh/clang:17
    steps:
      - uses: actions/checkout@v4
      - name: Run cppcheck
        run: |
          apt-get update && apt-get install -y --no-install-recommends cppcheck
          cppcheck --enable=warning,style --std=c++17 --quiet firmware/src firmware/include
